<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Margin Dashboard</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-datalabels/2.2.0/chartjs-plugin-datalabels.min.js"></script>
<style>
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:system-ui,sans-serif;background:#f9fafb;color:#111;padding:16px}
h1{font-size:20px;font-weight:700}
h2{font-size:16px;font-weight:700;color:#fff;padding:0;margin:0}
.sub{font-size:11px;color:#9ca3af;margin-top:2px}
.card{background:#fff;border-radius:12px;border:1px solid #e5e7eb;padding:16px;margin-bottom:12px}
.kpis{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin:12px 0}
.kpi{background:#fff;border-radius:12px;border:1px solid #e5e7eb;padding:12px}
.kpi-label{font-size:11px;color:#9ca3af}
.kpi-val{font-size:22px;font-weight:700;margin-top:2px}
.kpi-val.neg{color:#dc2626}
.controls{display:flex;flex-wrap:wrap;gap:8px;align-items:flex-start;background:#fff;border-radius:12px;border:1px solid #e5e7eb;padding:12px;margin-bottom:12px}
.sep{width:1px;height:16px;background:#e5e7eb;align-self:center}
button{cursor:pointer;border:none;border-radius:20px;font-size:12px;font-weight:500;padding:4px 12px;background:#f3f4f6;color:#374151}
button.ai{background:#4f46e5;color:#fff}
button.ap{background:#7c3aed;color:#fff}
button.aa{background:#f59e0b;color:#fff}
.tabs{display:flex;gap:8px;margin-bottom:12px}
.tab{font-size:12px;padding:6px 16px;border-radius:8px;border:1px solid transparent;background:transparent;font-weight:400;color:#6b7280;cursor:pointer}
.tab.active{background:#fff;border-color:#e5e7eb;font-weight:600;color:#111;box-shadow:0 1px 3px rgba(0,0,0,.06)}
table{width:100%;border-collapse:collapse}
th{text-align:left;font-size:11px;font-weight:600;color:#6b7280;padding:8px 12px;background:#f9fafb;border-bottom:1px solid #e5e7eb}
td{font-size:12px;padding:7px 12px;border-bottom:1px solid #f9fafb}
tr:nth-child(even) td{background:#f9fafb}
.badge{padding:2px 8px;border-radius:6px;font-size:11px;font-weight:600}
.bg{background:#d1fae5;color:#065f46}.by{background:#fef3c7;color:#92400e}
.bo{background:#ffedd5;color:#9a3412}.br{background:#fee2e2;color:#991b1b}
.gn{color:#059669;font-weight:500}.rd{color:#dc2626;font-weight:500}
.trunc{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:200px}
.live{font-size:11px;color:#059669;background:#d1fae5;padding:4px 10px;border-radius:20px;font-weight:500}
.hrow{display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:8px;margin-bottom:16px}
.hbtns{display:flex;gap:8px;align-items:center}
.sbtn{font-size:12px;padding:6px 12px;border-radius:8px;cursor:pointer;border:1px solid #e5e7eb;background:#f3f4f6;color:#374151}
.sbtn.bl{background:#4f46e5;color:#fff;border-color:#4f46e5}
.scroll-table{max-height:400px;overflow-y:auto}
.chart-wrap{position:relative;width:100%;height:380px}
.divider{border:none;border-top:2px solid #e5e7eb;margin:24px 0}
.section-title-wow{display:flex;align-items:center;gap:12px;background:linear-gradient(135deg,#4f46e5,#7c3aed);border-radius:12px;padding:14px 20px;margin-bottom:16px}
.section-title-mom{display:flex;align-items:center;gap:12px;background:linear-gradient(135deg,#d97706,#f59e0b);border-radius:12px;padding:14px 20px;margin-bottom:16px}
.stbadge{background:rgba(255,255,255,0.2);color:#fff;font-size:11px;font-weight:600;padding:3px 10px;border-radius:20px;margin-left:auto}
.filter-wrap{display:flex;flex-direction:column;gap:6px;flex:1;min-width:200px}
.tags-row{display:flex;flex-wrap:wrap;gap:4px;align-items:center}
.tag{display:inline-flex;align-items:center;gap:4px;background:#eef2ff;color:#4f46e5;border-radius:20px;padding:3px 8px;font-size:11px;font-weight:600}
.tag-x{cursor:pointer;font-size:13px;line-height:1;color:#6366f1;font-weight:700}
.tag-x:hover{color:#dc2626}
.clear-all{font-size:11px;color:#9ca3af;cursor:pointer;text-decoration:underline;white-space:nowrap}
.clear-all:hover{color:#dc2626}
.search-row{position:relative;display:flex;align-items:center;gap:6px}
.search-input{border:1px solid #e5e7eb;border-radius:8px;padding:4px 10px;font-size:12px;outline:none;font-family:inherit;background:#fff;width:180px}
.search-input:focus{border-color:#6366f1}
.dim-drop{display:none;position:absolute;top:100%;left:0;min-width:220px;background:#fff;border:1px solid #e5e7eb;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,.1);z-index:999;max-height:240px;overflow-y:auto;margin-top:4px}
.drop-item{padding:8px 12px;font-size:12px;cursor:pointer;color:#111}
.drop-item:hover{background:#eef2ff;color:#4f46e5}
.drop-item.focused{background:#f3f4f6}
</style>
</head>
<body>

<div id="loading" style="text-align:center;padding:80px;font-size:13px;color:#6b7280">Loading dataâ€¦</div>

<div id="dashboard" style="display:none">
  <div class="hrow">
    <div><h1>Margin Dashboard</h1><div class="sub" id="data-info">Loadingâ€¦</div></div>
    <div class="hbtns">
      <span class="live">â— Live</span>
      <button class="sbtn bl" onclick="loadAll()">â†º Refresh</button>
    </div>
  </div>

  <!-- WOW -->
  <div class="section-title-wow">
    <span style="font-size:22px">ğŸ“…</span>
    <h2>Week on Week View</h2>
    <span class="stbadge" id="wow-info">Loadingâ€¦</span>
  </div>
  <div class="kpis">
    <div class="kpi"><div class="kpi-label">Total Sales</div><div class="kpi-val" id="w-kpi-sales">â€”</div></div>
    <div class="kpi"><div class="kpi-label">Total Profit</div><div class="kpi-val" id="w-kpi-profit">â€”</div></div>
    <div class="kpi"><div class="kpi-label">Overall Margin</div><div class="kpi-val" id="w-kpi-margin">â€”</div></div>
  </div>
  <div class="controls">
    <button onclick="setView('w','category')" id="w-btn-cat" class="ap">By Category</button>
    <button onclick="setView('w','brand')" id="w-btn-brand">By Brand</button>
    <div class="sep"></div>
    <button onclick="setMetric('w','margin')" id="w-btn-margin" class="aa">Margin %</button>
    <button onclick="setMetric('w','profit')" id="w-btn-profit">Profit â‚¹</button>
    <button onclick="setMetric('w','sales')" id="w-btn-sales">Sales â‚¹</button>
    <button onclick="setMetric('w','combo')" id="w-btn-combo">Sales + Margin</button>
    <div class="sep"></div>
    <div class="filter-wrap">
      <div class="search-row">
        <input class="search-input" id="w-search" placeholder="Search categoriesâ€¦" autocomplete="off"
          oninput="onSearch('w')" onfocus="openDrop('w')" onkeydown="onKey('w',event)"/>
        <div class="dim-drop" id="w-drop"></div>
        <span class="clear-all" id="w-clear" style="display:none" onclick="clearAll('w')">Clear all</span>
      </div>
      <div class="tags-row" id="w-tags"></div>
    </div>
  </div>
  <div class="tabs">
    <button class="tab active" id="w-tab-charts" onclick="setTab('w','charts')">ğŸ“Š Charts</button>
    <button class="tab" id="w-tab-summary" onclick="setTab('w','summary')">ğŸ“‹ Summary</button>
    <button class="tab" id="w-tab-skus" onclick="setTab('w','skus')">ğŸ” SKU Detail</button>
  </div>
  <div id="w-pane-charts" class="card"><div class="chart-wrap"><canvas id="w-chart"></canvas></div></div>
  <div id="w-pane-summary" class="card" style="display:none;padding:0;overflow:hidden"><table id="w-summary-table"></table></div>
  <div id="w-pane-skus" class="card" style="display:none;padding:0;overflow:hidden">
    <div style="padding:8px 12px;background:#f9fafb;border-bottom:1px solid #e5e7eb;display:flex;justify-content:space-between">
      <span style="font-size:12px;font-weight:600">SKUs â€” worst margin first</span>
      <span style="font-size:11px;color:#9ca3af" id="w-sku-count"></span>
    </div>
    <div class="scroll-table"><table id="w-sku-table"></table></div>
  </div>

  <hr class="divider"/>

  <!-- MOM -->
  <div class="section-title-mom">
    <span style="font-size:22px">ğŸ“†</span>
    <h2>Month on Month View</h2>
    <span class="stbadge" id="mom-info">Loadingâ€¦</span>
  </div>
  <div class="kpis">
    <div class="kpi"><div class="kpi-label">Total Sales</div><div class="kpi-val" id="m-kpi-sales">â€”</div></div>
    <div class="kpi"><div class="kpi-label">Total Profit</div><div class="kpi-val" id="m-kpi-profit">â€”</div></div>
    <div class="kpi"><div class="kpi-label">Overall Margin</div><div class="kpi-val" id="m-kpi-margin">â€”</div></div>
  </div>
  <div class="controls">
    <button onclick="setView('m','category')" id="m-btn-cat" class="ap">By Category</button>
    <button onclick="setView('m','brand')" id="m-btn-brand">By Brand</button>
    <div class="sep"></div>
    <button onclick="setMetric('m','margin')" id="m-btn-margin" class="aa">Margin %</button>
    <button onclick="setMetric('m','profit')" id="m-btn-profit">Profit â‚¹</button>
    <button onclick="setMetric('m','sales')" id="m-btn-sales">Sales â‚¹</button>
    <button onclick="setMetric('m','combo')" id="m-btn-combo">Sales + Margin</button>
    <div class="sep"></div>
    <div class="filter-wrap">
      <div class="search-row">
        <input class="search-input" id="m-search" placeholder="Search categoriesâ€¦" autocomplete="off"
          oninput="onSearch('m')" onfocus="openDrop('m')" onkeydown="onKey('m',event)"/>
        <div class="dim-drop" id="m-drop"></div>
        <span class="clear-all" id="m-clear" style="display:none" onclick="clearAll('m')">Clear all</span>
      </div>
      <div class="tags-row" id="m-tags"></div>
    </div>
  </div>
  <div class="tabs">
    <button class="tab active" id="m-tab-charts" onclick="setTab('m','charts')">ğŸ“Š Charts</button>
    <button class="tab" id="m-tab-summary" onclick="setTab('m','summary')">ğŸ“‹ Summary</button>
    <button class="tab" id="m-tab-skus" onclick="setTab('m','skus')">ğŸ” SKU Detail</button>
  </div>
  <div id="m-pane-charts" class="card"><div class="chart-wrap"><canvas id="m-chart"></canvas></div></div>
  <div id="m-pane-summary" class="card" style="display:none;padding:0;overflow:hidden"><table id="m-summary-table"></table></div>
  <div id="m-pane-skus" class="card" style="display:none;padding:0;overflow:hidden">
    <div style="padding:8px 12px;background:#f9fafb;border-bottom:1px solid #e5e7eb;display:flex;justify-content:space-between">
      <span style="font-size:12px;font-weight:600">SKUs â€” worst margin first</span>
      <span style="font-size:11px;color:#9ca3af" id="m-sku-count"></span>
    </div>
    <div class="scroll-table"><table id="m-sku-table"></table></div>
  </div>
</div>

<div id="err-screen" style="display:none;max-width:480px;margin:80px auto;text-align:center">
  <div style="font-size:32px;margin-bottom:12px">âš ï¸</div>
  <div style="font-size:14px;font-weight:600;margin-bottom:8px">Could not load data</div>
  <div id="err-msg" style="font-size:12px;color:#6b7280;margin-bottom:16px"></div>
  <button class="sbtn bl" onclick="loadAll()">Try Again</button>
</div>

<script>
Chart.register(ChartDataLabels);

var WEEK_URL  = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSBtk0sRVzaiYZmxt7ahLyTUQ_b9S6EZ0fovOBVg1g60fAlSClGHZgTx3fAA-4l7YQsIVNfnQOYtzoa/pub?gid=1875279715&single=true&output=csv";
var MONTH_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSBtk0sRVzaiYZmxt7ahLyTUQ_b9S6EZ0fovOBVg1g60fAlSClGHZgTx3fAA-4l7YQsIVNfnQOYtzoa/pub?gid=1503333489&single=true&output=csv";
var PROXIES   = ["https://corsproxy.io/?","https://api.allorigins.win/raw?url="];
var COLORS    = ["#6366f1","#f59e0b","#10b981","#ef4444","#8b5cf6","#ec4899","#14b8a6","#f97316","#3b82f6","#84cc16","#e11d48","#0ea5e9"];
var MONTH_ORDER = {Jan:1,Feb:2,Mar:3,Apr:4,May:5,Jun:6,Jul:7,Aug:8,Sep:9,Oct:10,Nov:11,Dec:12};

var wData = [], mData = [];
var wChart = null, mChart = null;
var S = {
  w: {view:"category", metric:"margin", selected:[], focusIdx:-1},
  m: {view:"category", metric:"margin", selected:[], focusIdx:-1}
};

// â”€â”€ FORMATTERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function clean(v) { return parseFloat(String(v).replace(/,/g,"").replace(/%/g,"")) || 0; }
function INR(v) { return "â‚¹" + Math.abs(v).toLocaleString("en-IN",{maximumFractionDigits:0}); }
function fmtVal(v) {
  if (v == null) return null;
  var a = Math.abs(v), s = v < 0 ? "-" : "";
  if (a >= 100000) return s + "â‚¹" + (a/100000).toFixed(1) + "L";
  if (a >= 1000)   return s + "â‚¹" + (a/1000).toFixed(1) + "K";
  return s + "â‚¹" + a.toFixed(0);
}
function fmtPct(v) { return v == null ? null : v.toFixed(1) + "%"; }
function badge(v) {
  var c = v>=15?"bg":v>=5?"by":v>=0?"bo":"br";
  return '<span class="badge ' + c + '">' + v.toFixed(1) + '%</span>';
}
function monthSortKey(l) {
  var p = l.trim().split(/[\s']+/);
  var m = MONTH_ORDER[p[0]] || 0;
  var y = parseInt(p[1] || "0");
  return (y < 50 ? 2000+y : 1900+y) * 100 + m;
}

// â”€â”€ CSV PARSER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function parseCSV(text, periodCol) {
  var lines = text.trim().split("\n").filter(function(l) { return l.trim(); });
  var hdrs = lines[0].split(",").map(function(h) { return h.trim().toLowerCase().replace(/"/g,""); });
  function ix(h) { return hdrs.findIndex(function(x) { return x.includes(h); }); }
  var iN=ix("item"), iS=ix("sku"), iC=ix("category"), iB=ix("brand"),
      iQ=ix("qty"), iCo=ix("total cost"), iSa=ix("total sales"),
      iP=ix("profit"), iM=ix("margin"), iPer=ix(periodCol.toLowerCase());
  var rows = [];
  for (var i = 1; i < lines.length; i++) {
    var l = lines[i], c = [], cur = "", inQ = false;
    for (var j = 0; j < l.length; j++) {
      if (l[j] === '"') inQ = !inQ;
      else if (l[j] === ',' && !inQ) { c.push(cur.trim()); cur = ""; }
      else cur += l[j];
    }
    c.push(cur.trim());
    if (c.length < 5) continue;
    var r = {
      name:     (c[iN]  || "").replace(/"/g,"").trim(),
      sku:      (c[iS]  || "").replace(/"/g,"").trim(),
      category: (c[iC]  || "").replace(/"/g,"").trim(),
      brand:    (c[iB]  || "").replace(/"/g,"").trim(),
      qty:      clean(c[iQ]),
      cost:     clean(c[iCo]),
      sales:    clean(c[iSa]),
      profit:   clean(c[iP]),
      margin:   clean(c[iM]),
      period:   (c[iPer] || "").replace(/"/g,"").trim()
    };
    if (r.name && r.category && r.period) rows.push(r);
  }
  return rows;
}

// â”€â”€ FETCH WITH PROXY FALLBACK â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function fetchWithTimeout(url, ms) {
  var ctrl = new AbortController();
  var tid = setTimeout(function() { ctrl.abort(); }, ms);
  try {
    var r = await fetch(url, {signal: ctrl.signal});
    clearTimeout(tid);
    return r;
  } catch (err) {
    clearTimeout(tid);
    throw err;
  }
}

async function fetchCSV(url) {
  // 1. Try direct
  try {
    var r = await fetchWithTimeout(url, 5000);
    if (r.ok) return await r.text();
  } catch (e1) { /* fall through */ }

  // 2. Try each proxy
  for (var pi = 0; pi < PROXIES.length; pi++) {
    try {
      var proxyUrl = PROXIES[pi] + encodeURIComponent(url);
      var r2 = await fetchWithTimeout(proxyUrl, 8000);
      if (r2.ok) return await r2.text();
    } catch (e2) { /* try next */ }
  }

  throw new Error("All fetch attempts failed for: " + url);
}

// â”€â”€ LOAD DATA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadAll() {
  document.getElementById("loading").style.display = "block";
  document.getElementById("dashboard").style.display = "none";
  document.getElementById("err-screen").style.display = "none";

  var wOk = false, mOk = false;

  var wPromise = fetchCSV(WEEK_URL).then(function(text) {
    wData = parseCSV(text, "week");
    if (wData.length) {
      wOk = true;
      document.getElementById("loading").style.display = "none";
      document.getElementById("dashboard").style.display = "block";
      document.getElementById("wow-info").textContent = wData.length + " rows Â· " + uniqueCount(wData,"sku") + " SKUs";
      renderSection("w");
    }
  }).catch(function(e) { console.warn("WoW failed:", e.message); });

  var mPromise = fetchCSV(MONTH_URL).then(function(text) {
    mData = parseCSV(text, "month");
    if (mData.length) {
      mOk = true;
      document.getElementById("loading").style.display = "none";
      document.getElementById("dashboard").style.display = "block";
      document.getElementById("mom-info").textContent = mData.length + " rows Â· " + uniqueCount(mData,"sku") + " SKUs";
      document.getElementById("data-info").textContent = "Week & Month tabs loaded";
      renderSection("m");
    }
  }).catch(function(e) { console.warn("MoM failed:", e.message); });

  await Promise.all([wPromise, mPromise]);

  if (!wOk && !mOk) {
    document.getElementById("loading").style.display = "none";
    document.getElementById("err-screen").style.display = "block";
    document.getElementById("err-msg").textContent = "Could not load data. Please try refreshing.";
  }
}

function uniqueCount(arr, key) {
  return new Set(arr.map(function(d) { return d[key]; })).size;
}

// â”€â”€ STATE CONTROLS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getData(sec) { return sec === "w" ? wData : mData; }

function setView(sec, v) {
  S[sec].view = v;
  S[sec].selected = [];
  document.getElementById(sec+"-btn-cat").className   = v === "category" ? "ap" : "";
  document.getElementById(sec+"-btn-brand").className = v === "brand"    ? "ap" : "";
  document.getElementById(sec+"-search").placeholder  = "Search " + v + "sâ€¦";
  updateTags(sec);
  renderSection(sec);
}

function setMetric(sec, m) {
  S[sec].metric = m;
  ["margin","profit","sales","combo"].forEach(function(x) {
    document.getElementById(sec+"-btn-"+x).className = x === m ? "aa" : "";
  });
  renderSection(sec);
}

function setTab(sec, t) {
  ["charts","summary","skus"].forEach(function(x) {
    document.getElementById(sec+"-tab-"+x).className  = "tab" + (x === t ? " active" : "");
    document.getElementById(sec+"-pane-"+x).style.display = x === t ? "block" : "none";
  });
  renderSection(sec);
}

// â”€â”€ SEARCH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getDims(sec) {
  var key = S[sec].view === "category" ? "category" : "brand";
  return [...new Set(getData(sec).map(function(d) { return d[key]; }))].filter(Boolean).sort();
}

function getFiltered(sec) {
  var data = getData(sec), st = S[sec];
  var key = st.view === "category" ? "category" : "brand";
  if (!st.selected.length) return data;
  return data.filter(function(d) { return st.selected.indexOf(d[key]) >= 0; });
}

function getActiveDims(sec) {
  var all = getDims(sec), st = S[sec];
  return st.selected.length ? st.selected.filter(function(d) { return all.indexOf(d) >= 0; }) : all;
}

function openDrop(sec) { onSearch(sec); }

function onSearch(sec) {
  var q = document.getElementById(sec+"-search").value;
  var all = getDims(sec).filter(function(d) { return S[sec].selected.indexOf(d) < 0; });
  var matches = q.trim() === "" ? all : all.filter(function(d) { return d.toLowerCase().includes(q.toLowerCase()); });
  S[sec].focusIdx = -1;
  renderDrop(sec, matches, q);
}

function renderDrop(sec, items, q) {
  var drop = document.getElementById(sec+"-drop");
  if (!items.length) { drop.style.display = "none"; return; }
  drop.innerHTML = items.map(function(d, i) {
    var label = q && q.trim()
      ? d.replace(new RegExp("("+q.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")+")","gi"),
          '<span style="color:#4f46e5;font-weight:700">$1</span>')
      : d;
    return '<div class="drop-item" id="'+sec+'-di-'+i+'" onclick="selectDim(\''+sec+'\',\''+escQ(d)+'\')">'+label+'</div>';
  }).join("");
  drop.style.display = "block";
}

function escQ(s) { return s.replace(/\\/g,"\\\\").replace(/'/g,"\\'"); }

function onKey(sec, e) {
  var drop = document.getElementById(sec+"-drop");
  var items = drop.querySelectorAll(".drop-item");
  var st = S[sec];
  if (e.key === "ArrowDown") {
    e.preventDefault();
    st.focusIdx = Math.min(st.focusIdx+1, items.length-1);
    highlightDrop(items, st.focusIdx);
  } else if (e.key === "ArrowUp") {
    e.preventDefault();
    st.focusIdx = Math.max(st.focusIdx-1, 0);
    highlightDrop(items, st.focusIdx);
  } else if (e.key === "Enter") {
    e.preventDefault();
    if (items.length === 1) {
      items[0].click();
    } else if (st.focusIdx >= 0 && items[st.focusIdx]) {
      items[st.focusIdx].click();
    }
  } else if (e.key === "Escape") {
    drop.style.display = "none";
  } else if (e.key === "Backspace") {
    var inp = document.getElementById(sec+"-search");
    if (inp.value === "" && st.selected.length) {
      st.selected.pop();
      updateTags(sec);
      renderSection(sec);
      onSearch(sec);
    }
  }
}

function highlightDrop(items, idx) {
  items.forEach(function(el, i) { el.classList.toggle("focused", i === idx); });
  if (items[idx]) items[idx].scrollIntoView({block:"nearest"});
}

function selectDim(sec, d) {
  if (S[sec].selected.indexOf(d) < 0) S[sec].selected.push(d);
  document.getElementById(sec+"-search").value = "";
  document.getElementById(sec+"-drop").style.display = "none";
  S[sec].focusIdx = -1;
  updateTags(sec);
  renderSection(sec);
  document.getElementById(sec+"-search").focus();
}

function removeDim(sec, d) {
  S[sec].selected = S[sec].selected.filter(function(x) { return x !== d; });
  updateTags(sec);
  renderSection(sec);
}

function clearAll(sec) {
  S[sec].selected = [];
  document.getElementById(sec+"-search").value = "";
  updateTags(sec);
  renderSection(sec);
}

function updateTags(sec) {
  var sel = S[sec].selected;
  document.getElementById(sec+"-tags").innerHTML = sel.map(function(d) {
    return '<span class="tag">' + d + '<span class="tag-x" onclick="removeDim(\''+sec+'\',\''+escQ(d)+'\')">Ã—</span></span>';
  }).join("");
  document.getElementById(sec+"-clear").style.display = sel.length ? "inline" : "none";
}

document.addEventListener("click", function(e) {
  ["w","m"].forEach(function(sec) {
    var inp  = document.getElementById(sec+"-search");
    var drop = document.getElementById(sec+"-drop");
    if (inp && drop && !inp.contains(e.target) && !drop.contains(e.target)) {
      drop.style.display = "none";
    }
  });
});

// â”€â”€ CHART HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function dlBar(color) {
  return {display:true,anchor:"end",align:"top",offset:2,color:color,font:{size:10,weight:"600"},
    formatter:function(v) { return v == null ? null : fmtVal(v); }};
}
function dlLine(color) {
  return {display:true,anchor:"end",align:"top",offset:8,color:color,font:{size:10,weight:"600"},
    formatter:function(v) { return v == null ? null : fmtPct(v); }};
}

// â”€â”€ RENDER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderSection(sec) {
  var st = S[sec];
  var dimKey = st.view === "category" ? "category" : "brand";
  var dims = getActiveDims(sec);
  var fd   = getFiltered(sec);

  // KPIs
  var totS = 0, totP = 0;
  fd.forEach(function(r) { totS += r.sales; totP += r.profit; });
  var totM = totS ? totP/totS*100 : 0;
  document.getElementById(sec+"-kpi-sales").textContent   = INR(totS);
  document.getElementById(sec+"-kpi-profit").textContent  = (totP<0?"-":"") + INR(totP);
  document.getElementById(sec+"-kpi-profit").className    = "kpi-val" + (totP<0?" neg":"");
  document.getElementById(sec+"-kpi-margin").textContent  = totM.toFixed(1) + "%";
  document.getElementById(sec+"-kpi-margin").className    = "kpi-val" + (totM<0?" neg":"");

  // Periods
  var pSet = {};
  fd.forEach(function(d) { pSet[d.period] = true; });
  var periods = Object.keys(pSet).sort(function(a,b) {
    if (sec === "w") return parseInt(a.replace("W","")) - parseInt(b.replace("W",""));
    return monthSortKey(a) - monthSortKey(b);
  });

  // Per-dim values
  var chartData = periods.map(function(p) {
    var row = {};
    dims.forEach(function(dim) {
      var rows = fd.filter(function(d) { return d[dimKey]===dim && d.period===p; });
      if (!rows.length) { row[dim] = null; return; }
      var s=0, pr=0;
      rows.forEach(function(r) { s+=r.sales; pr+=r.profit; });
      row[dim] = st.metric==="margin"  ? parseFloat((s?pr/s*100:0).toFixed(2))
               : st.metric==="profit"  ? parseFloat(pr.toFixed(2))
               :                         parseFloat(s.toFixed(2));
    });
    return row;
  });

  // Destroy old chart
  if (sec==="w" && wChart) { wChart.destroy(); wChart = null; }
  if (sec==="m" && mChart) { mChart.destroy(); mChart = null; }
  var ctx = document.getElementById(sec+"-chart").getContext("2d");
  var nc;

  var baseOpts = {
    responsive:true, maintainAspectRatio:false,
    layout:{padding:{top:40,right:16}},
    plugins:{datalabels:{}, legend:{labels:{font:{size:11}}}}
  };

  if (st.metric === "combo") {
    var salesData = periods.map(function(p) {
      var rows = fd.filter(function(d) { return d.period===p; });
      var s=0; rows.forEach(function(r) { s+=r.sales; }); return parseFloat(s.toFixed(2));
    });
    var marginData = periods.map(function(p) {
      var rows = fd.filter(function(d) { return d.period===p; });
      var s=0,pr=0; rows.forEach(function(r) { s+=r.sales; pr+=r.profit; });
      return parseFloat((s?pr/s*100:0).toFixed(2));
    });
    nc = new Chart(ctx, {
      type:"bar",
      data:{labels:periods, datasets:[
        {label:"Sales (â‚¹)",data:salesData,backgroundColor:"#6366f1cc",borderColor:"#6366f1",borderWidth:1,borderRadius:3,yAxisID:"y",
          datalabels:{display:true,anchor:"end",align:"top",offset:2,color:"#4338ca",font:{size:10,weight:"600"},formatter:function(v){return fmtVal(v);}}},
        {label:"Margin %",data:marginData,type:"line",borderColor:"#f59e0b",backgroundColor:"#f59e0b22",borderWidth:2,pointRadius:5,pointBackgroundColor:"#f59e0b",tension:0.3,yAxisID:"y2",
          datalabels:{display:true,anchor:"end",align:"top",offset:8,color:"#b45309",font:{size:10,weight:"600"},formatter:function(v){return fmtPct(v);}}}
      ]},
      options:{responsive:true,maintainAspectRatio:false,layout:{padding:{top:40,right:16}},
        plugins:{datalabels:{},legend:{labels:{font:{size:11}}},
          tooltip:{callbacks:{label:function(c){return c.dataset.yAxisID==="y2"?" "+c.dataset.label+": "+c.parsed.y.toFixed(1)+"%":" "+c.dataset.label+": "+INR(c.parsed.y);}}}},
        scales:{x:{ticks:{font:{size:11}}},
          y:{ticks:{font:{size:11},callback:function(v){return fmtVal(v);}},grid:{color:"#f0f0f0"},title:{display:true,text:"Sales",font:{size:10}}},
          y2:{position:"right",ticks:{font:{size:11},callback:function(v){return v.toFixed(0)+"%";}},grid:{drawOnChartArea:false},title:{display:true,text:"Margin %",font:{size:10}}}}}
    });
  } else if (st.metric === "margin") {
    nc = new Chart(ctx, {
      type:"line",
      data:{labels:periods, datasets:dims.map(function(dim,i){
        var col=COLORS[i%COLORS.length];
        return{label:dim,data:chartData.map(function(r){return r[dim];}),backgroundColor:col+"22",borderColor:col,borderWidth:2,pointRadius:5,pointBackgroundColor:col,tension:0.3,fill:false,datalabels:dlLine(col)};
      })},
      options:{responsive:true,maintainAspectRatio:false,layout:{padding:{top:40,right:16}},
        plugins:{datalabels:{},legend:{labels:{font:{size:11}}},tooltip:{callbacks:{label:function(c){return" "+c.dataset.label+": "+c.parsed.y.toFixed(1)+"%";}}}},
        scales:{x:{ticks:{font:{size:11}}},y:{ticks:{font:{size:11},callback:function(v){return v.toFixed(0)+"%";}},grid:{color:"#f0f0f0"}}}}
    });
  } else {
    nc = new Chart(ctx, {
      type:"bar",
      data:{labels:periods, datasets:dims.map(function(dim,i){
        var col=COLORS[i%COLORS.length];
        return{label:dim,data:chartData.map(function(r){return r[dim];}),backgroundColor:col+"cc",borderColor:col,borderWidth:1,borderRadius:3,datalabels:dlBar(col)};
      })},
      options:{responsive:true,maintainAspectRatio:false,layout:{padding:{top:40,right:16}},
        plugins:{datalabels:{},legend:{labels:{font:{size:11}}},tooltip:{callbacks:{label:function(c){return" "+c.dataset.label+": "+INR(c.parsed.y);}}}},
        scales:{x:{ticks:{font:{size:11}}},y:{ticks:{font:{size:11},callback:function(v){return fmtVal(v);}},grid:{color:"#f0f0f0"}}}}
    });
  }

  if (sec==="w") wChart=nc; else mChart=nc;

  // Summary table
  var sumData = dims.map(function(dim) {
    var rows = fd.filter(function(d) { return d[dimKey]===dim; });
    var s=0,p=0,c=0,q=0;
    rows.forEach(function(r) { s+=r.sales; p+=r.profit; c+=r.cost; q+=r.qty; });
    return {dim:dim,s:s,p:p,c:c,q:q,m:s?p/s*100:0};
  }).sort(function(a,b) { return b.m-a.m; });
  var dh = st.view==="category" ? "Category" : "Brand";
  document.getElementById(sec+"-summary-table").innerHTML =
    '<thead><tr><th>'+dh+'</th><th>Sales</th><th>Cost</th><th>Profit</th><th>Margin</th><th>Qty</th></tr></thead><tbody>'+
    sumData.map(function(r) {
      return '<tr><td style="font-weight:500">'+r.dim+'</td><td>'+INR(r.s)+'</td><td>'+INR(r.c)+'</td>'+
        '<td class="'+(r.p<0?"rd":"gn")+'">'+(r.p<0?"-":"")+INR(r.p)+'</td>'+
        '<td>'+badge(r.m)+'</td><td style="color:#6b7280">'+r.q+'</td></tr>';
    }).join("") + '</tbody>';

  // SKU table
  var skuMap = {};
  fd.forEach(function(d) {
    if (!skuMap[d.sku]) skuMap[d.sku] = {name:d.name,sku:d.sku,cat:d.category,brand:d.brand,s:0,p:0,c:0,q:0};
    skuMap[d.sku].s+=d.sales; skuMap[d.sku].p+=d.profit; skuMap[d.sku].c+=d.cost; skuMap[d.sku].q+=d.qty;
  });
  var skus = Object.values(skuMap)
    .map(function(r) { return Object.assign({},r,{m:r.s?r.p/r.s*100:0}); })
    .sort(function(a,b) { return a.m-b.m; });
  document.getElementById(sec+"-sku-count").textContent = skus.length + " SKUs";
  document.getElementById(sec+"-sku-table").innerHTML =
    '<thead><tr><th>Item</th><th>Category</th><th>Brand</th><th>Sales</th><th>Profit</th><th>Margin</th><th>Qty</th></tr></thead><tbody>'+
    skus.map(function(r) {
      return '<tr><td class="trunc" title="'+r.name+'">'+r.name+'</td>'+
        '<td style="color:#6b7280">'+r.cat+'</td><td style="color:#6b7280">'+r.brand+'</td>'+
        '<td>'+INR(r.s)+'</td><td class="'+(r.p<0?"rd":"gn")+'">'+(r.p<0?"-":"")+INR(r.p)+'</td>'+
        '<td>'+badge(r.m)+'</td><td style="color:#6b7280">'+r.q+'</td></tr>';
    }).join("") + '</tbody>';
}

window.onload = function() { loadAll(); };
</script>
</body>
</html>
